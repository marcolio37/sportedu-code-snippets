/**
 * Shortcode [acf_linkkilista_swiper]
 * Lisää Swiper-karusellin kuville linkit, jotka haetaan ACF:n gallerian kuvista ja niihin liittyvistä linkeistä.
 *
 * Tämä shortcode lisää sivulle JavaScript-koodin, joka liittää karusellin jokaisen slide-elementin päälle kattavan <a>-elementin,
 * mikäli kyseisen kuvan ID:lle on määritelty linkki.
 *
 * Käyttö:
 * - Olettaa, että sivulla on Swiper-karuselli, jossa slidit tunnistetaan valitsimella '.kuvakaruselli-linkit .swiper-slide'
 * - Käyttää ACF-kenttää 'kouluttajakuvakaruselli' kuvagallerian hakemiseen
 * - Käyttää ACF-kenttää 'kouluttajakuvakaruselli_linkit', joka sisältää JSON-muotoisen kartan kuvan ID:stä linkkiin
 *
 * @return string JavaScript-koodi, joka lisätään sivun loppuun
 */
add_shortcode('acf_linkkilista_swiper', function() {
    // Haetaan nykyisen postauksen ID
    $post_id = get_the_ID();
    if (!$post_id) {
        return ''; // Jos ei postauksen kontekstia, ei tehdä mitään
    }

    // Haetaan ACF-galleria (voi olla taulukko objekteja tai id:tä)
    $gallery = get_field('kouluttajakuvakaruselli', $post_id);
    // Haetaan JSON-linkit ja puretaan taulukoksi
    $links_json = get_field('kouluttajakuvakaruselli_linkit', $post_id);
    $links_array = $links_json ? json_decode($links_json, true) : [];

    $ordered_links = [];

    // Käydään galleria läpi ja muodostetaan linkkitaulukko kuvien järjestyksessä
    if (is_array($gallery) && is_array($links_array)) {
        foreach ($gallery as $image) {
            $image_id = null;

            // Selvitetään kuvan ID eri muodoista
            if (is_array($image)) {
                if (!empty($image['ID']) && is_numeric($image['ID'])) {
                    $image_id = (int) $image['ID'];
                } elseif (is_numeric($image)) {
                    $image_id = (int) $image;
                }
            } elseif (is_numeric($image)) {
                $image_id = (int) $image;
            }

            // Jos linkki löytyy kyseiselle kuvalle, lisätään se, muuten tyhjä merkkijono
            if ($image_id !== null && isset($links_array[$image_id])) {
                $ordered_links[] = esc_url_raw($links_array[$image_id]);
            } else {
                $ordered_links[] = '';
            }
        }
    }

    // Jos ei linkkejä, ei anneta mitään palautusarvoa
    if (empty($ordered_links)) {
        return '';
    }

    ob_start();
    ?>
    <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // Taulukko linkeistä kuhunkin slideen
        var links = <?php echo wp_json_encode($ordered_links, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP); ?>;

        // Haetaan Swiper-karusellin slidit valitsimella
        var slides = document.querySelectorAll('.kuvakaruselli-linkit .swiper-slide');

        slides.forEach(function(slide, index) {
            var href = links[index] || '';
            if (href) {
                // Luodaan kattava <a>-elementti, joka peittää koko slidin ja tekee siitä klikattavan
                var linkEl = document.createElement('a');
                linkEl.href = href;
                linkEl.style.position = 'absolute';
                linkEl.style.top = '0';
                linkEl.style.left = '0';
                linkEl.style.width = '100%';
                linkEl.style.height = '100%';
                linkEl.style.zIndex = '10';
                linkEl.setAttribute('aria-label', 'Linkki koulutusjärjestäjälle'); // Saavutettavuusominaisuus

                // Varmistetaan, että slide-elementillä on position: relative,
                // jotta absoluuttisesti sijoitettu <a> toimii oikein
                var slidePosition = window.getComputedStyle(slide).position;
                if (slidePosition === 'static' || slidePosition === '') {
                    slide.style.position = 'relative';
                }

                slide.appendChild(linkEl);
            }
        });
    });
    </script>
    <?php
    return ob_get_clean();
});
