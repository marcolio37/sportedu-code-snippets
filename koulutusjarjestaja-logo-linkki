/**
 * Shortcode [kouluttaja_logo size="thumbnail|medium|large|full" alt="vaihtoehtoinen teksti" linkki="true|false"]
 * Näyttää koulutusjärjestäjän logon halutulla kuvakoolla.
 * Parametri 'linkki' määrittää, lisätäänkö kuvaan linkki järjestäjän sivulle (oletus 'false').
 *
 * Alt-tekstiksi muodostetaan "[koulutusjärjestäjä] -logo", jos koulutusjärjestäjän nimi saadaan,
 * muuten käytetään shortcode-attribuutissa annettua alt-tekstiä tai ACF-kuvakentän alt-tekstiä.
 *
 * @param array $atts Shortcode-attribuutit.
 * @return string HTML-kuva (img) tai tyhjä merkkijono.
 */
add_shortcode('kouluttaja_logo', function($atts) {
    // Määritellään shortcode-attribuuttien oletusarvot
    $atts = shortcode_atts([
        'size'   => 'medium',
        'alt'    => '',      // vaihtoehtoinen alt-teksti
        'linkki' => 'false', // lisätäänkö linkki
    ], $atts, 'kouluttaja_logo');

    $post_id = get_the_ID();
    if (!$post_id) {
        return ''; // Ei postauskontekstia, ei tuoteta mitään
    }

    // Haetaan koulutusjärjestäjä (voi olla objekti tai ID)
    $kouluttaja = get_field('koulutusjarjestaja', $post_id);
    if (!$kouluttaja) {
        return ''; // Ei löydy koulutusjärjestäjää
    }

    $kouluttaja_id = is_object($kouluttaja) ? $kouluttaja->ID : $kouluttaja;

    // Haetaan logo ACF-kuvakentästä
    $logo = get_field('logo', $kouluttaja_id);
    if (!$logo || !is_array($logo)) {
        return ''; // Logo ei löydy tai ei odotetussa muodossa
    }

    // Haetaan haluttu kuvakoko, jos sitä ei löydy, käytetään alkuperäistä URL:ia
    $size = sanitize_key($atts['size']);
    $image_url = isset($logo['sizes'][$size]) ? esc_url($logo['sizes'][$size]) : esc_url($logo['url']);

    // Haetaan koulutusjärjestäjän nimi (postin title)
    $koulutusjarjestaja_nimi = '';
    if (is_object($kouluttaja) && !empty($kouluttaja->post_title)) {
        $koulutusjarjestaja_nimi = $kouluttaja->post_title;
    } elseif (is_numeric($kouluttaja)) {
        $koulutusjarjestaja_nimi = get_the_title($kouluttaja);
    }

    // Muodostetaan alt-teksti: prioriteetti nimelle, sitten shortcode-attribuutille, lopuksi kuvan omalle alt-tekstille
    if (!empty($koulutusjarjestaja_nimi)) {
        $alt_text = $koulutusjarjestaja_nimi . ' -logo';
    } else {
        $alt_text = $atts['alt'];
        if (empty($alt_text) && !empty($logo['alt'])) {
            $alt_text = $logo['alt'];
        }
    }
    $alt_text = esc_attr($alt_text);

    // Luodaan kuvan HTML
    $img = '<img src="' . $image_url . '" alt="' . $alt_text . '">';

    // Jos linkki attribuutti on true, lisätään kuvaan linkki koulutusjärjestäjän sivulle
    if (filter_var($atts['linkki'], FILTER_VALIDATE_BOOLEAN)) {
        $permalink = get_permalink($kouluttaja_id);
        if ($permalink) {
            $img = '<a href="' . esc_url($permalink) . '">' . $img . '</a>';
        }
    }

    return $img;
});
